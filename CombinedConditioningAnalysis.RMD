---
title: "Combined Conditioning Analysis"
author: "KG"
date: "May 16, 2019"
output: html_document
---

```{r setup, include=FALSE}
rm(list=ls())
```

```{r read in data}
data2018 <- read.csv("C:/Users/kkmgo/OneDrive/Documents/Caretta caretta Conditioning 2017/2018/2018_testperiod_means.csv")
data2017 <- read.csv("C:/Users/kkmgo/OneDrive/Documents/Caretta caretta Conditioning 2017/2018/2017_testperiod_means.csv")
```

```{r adjust data frames}
library(dplyr)

data2017 <- data2017 %>% mutate(date=ifelse(Date=="Dec9","12/9/2017",ifelse(Date=="Dec10","12/10/2017",ifelse(Date=="Dec11","12/11/2017",ifelse(Date=="Dec12","12/12/2017","12/13/2017")))))
data2017$date <- as.Date(data2017$date,format="%m/%d/%Y")

data2017 <- data2017 %>% select(c("ID","FieldType","date","Freq","Group","Prop","MagField"))
names(data2017)<-c("id","field.type","date","mean.time","group","prop","field")

data2018<- data2018 %>% select(-c("X"))

data<- rbind(data2017,data2018)
```

```{r statistical tests and models, echo=TRUE}
wilcox.test(prop~field.type,data)
t.test(prop~field.type,data)

wilcox.test(prop~field.type,subset(data,group=="blue"))
wilcox.test(prop~field.type,subset(data,group=="orange"))
wilcox.test(prop~field.type,subset(data,group=="Red"))
wilcox.test(prop~field.type,subset(data,group=="Purple"))

library(car)
leveneTest(prop~group,data = data)
leveneTest(prop~group,data = data2017)
leveneTest(prop~group,data = data2018)

leveneTest(prop~field,data = data)
leveneTest(prop~field,data = data2017)
leveneTest(prop~field,data = data2018)

leveneTest(prop~field.type,data = data)
leveneTest(prop~field.type,data = data2017)
leveneTest(prop~field.type,data = data2018)


library(nlme)
lm1<- lm(prop~field*group+id,data=data)
summary(lm1)
anova(lm1)

lme1 <- lme(mean.time~field.type,random=~1|id/group/date,data=data)
summary(lme1)

lme2 <- lme(mean.time~field.type,random=~1|id/group,data=data)
summary(lme2)

lme3 <- lme(mean.time~field.type,random=~1|group,data=data)
summary(lme3)

lme4 <- lme(mean.time~field.type,random=~1|id/field/date,data=data)
summary(lme4)

anova(lme1,lme2,lme3,lme4)

```

```{r ggplots, echo=TRUE}
library(ggplot2)
library(cowplot)
library(grid)
library(gridExtra)
library(ggpubr)
library(extrafont)
library(ggsignif)

my_comparisons<- list(c("conditioned","control"))

annotation_df1 <- data.frame(field.type=rep(c("conditioned","conditioned")),
                            y=c(0.45,0.47))

annotation_df2 <- data.frame(field.type=rep(c("conditioned","control")),
                            y=c(0.47,0.47))

annotation_df3 <- data.frame(field.type=rep(c("control","control")),
                            y=c(0.47,0.45))


figure1<-ggplot(data,aes(x=field.type,y=prop))+
  stat_boxplot(geom="errorbar",color="black")+
  geom_boxplot(outlier.shape=NA,fill="#CCCCCC",color="black")+
  geom_point(color="black",position="jitter")+
  theme_bw()+scale_y_continuous(name = "Proportion of Time",breaks=c(0.00,0.05,0.1,0.15,0.2,0.25,0.3,0.35,0.4,0.45,0.5),limits=c(0,0.5))+
  theme(axis.title.x=element_text(margin = margin(t = 20, r = 0, b = 0, l = 0),size=20))+
  theme(axis.title.y= element_text(margin = margin(t = 0, r = 20, b = 0, l = 0),size=20))+
  scale_x_discrete(name="Treatment")+theme(text=element_text(size=18,family="Calibri"))+
  theme(panel.border = element_blank(), panel.grid.major = element_blank(),panel.grid.minor = element_blank(), axis.line =  element_line(colour = "black"))+
  geom_line(data=annotation_df1,aes(x=field.type,y=y))+
  geom_segment(data=annotation_df2,aes(x="conditioned",xend="control",y=0.47,yend=0.47))+
  geom_line(data=annotation_df3,aes(x=field.type,y=y))+
   annotate("text",
           x = c(1.5),
           y = c(0.49),
           label = c("p < 0.0001"),
           family = "", fontface = 3, size=4)
figure1



figure2<-ggplot(subset(data,group=="Red"),aes(x=field.type,y=prop))+
  stat_boxplot(color="black")+
  geom_boxplot(outlier.shape=NA,fill="#DEDEDE",color="black")+
  geom_point(color="black",position="jitter")+
  theme_bw()+
  scale_y_continuous(breaks=c(0.00,0.1,0.2,0.3,0.4,0.5),limits=c(0,0.5))+
  theme(axis.title.x=element_text(margin = margin(t = 20, r = 0, b = 0, l = 0),size=20))+
  theme(axis.title.y= element_text(margin = margin(t = 0, r = 20, b = 0, l = 0),size=20))+
  theme(text=element_text(size=16,family="Calibri"),axis.title.x = element_blank(),axis.title.y=element_blank())+
  theme(plot.margin = margin(t=40,r=20,b=10,l=20))+
  ggtitle("Canada Group")+
  theme(plot.title = element_text(size = 16,hjust=0.5,family = "Calibri Light",margin = margin(t=0,r=0,b=10,l=0)))+
  theme(panel.border = element_blank(), panel.grid.major = element_blank(),panel.grid.minor = element_blank(), axis.line = element_line(colour = "black"))+
  geom_line(data=annotation_df1,aes(x=field.type,y=y))+
  geom_segment(data=annotation_df2,aes(x="conditioned",xend="control",y=0.47,yend=0.47))+
  geom_line(data=annotation_df3,aes(x=field.type,y=y))+
   annotate("text",
           x = c(1.5),
           y = c(0.5),
           label = c("p < 0.01"),
           family = "", fontface = 3, size=4)
figure2


figure3<-ggplot(subset(data,group=="Purple"),aes(x=field.type,y=prop))+
  stat_boxplot(color="black")+
  geom_boxplot(outlier.shape=NA,fill="#BABABA",color="black")+
  geom_point(color="black",position="jitter")+
  theme_bw()+
  scale_y_continuous(breaks=c(0.00,0.1,0.2,0.3,0.4,0.5),limits=c(0,0.5))+
  theme(axis.title.x=element_text(margin = margin(t = 20, r = 0, b = 0, l = 0),size=20))+
  theme(axis.title.y= element_text(margin = margin(t = 0, r = 20, b = 0, l = 0),size=20))+
  theme(text=element_text(size=16,family="Calibri"),axis.title.x = element_blank(),axis.title.y=element_blank())+
  theme(plot.margin = margin(t=40,r=20,b=10,l=20))+
  ggtitle("Bahamas Group")+
  theme(plot.title = element_text(size = 16,hjust=0.5,family = "Calibri Light",margin = margin(t=0,r=0,b=10,l=0)))+
  theme(panel.border = element_blank(), panel.grid.major = element_blank(),panel.grid.minor = element_blank(), axis.line = element_line(colour = "black"))+
  geom_line(data=annotation_df1,aes(x=field.type,y=y))+
  geom_segment(data=annotation_df2,aes(x="conditioned",xend="control",y=0.47,yend=0.47))+
  geom_line(data=annotation_df3,aes(x=field.type,y=y))+
   annotate("text",
           x = c(1.5),
           y = c(0.5),
           label = c("p = 0.03"),
           family = "", fontface = 3, size=4)
figure3


figure4<-ggplot(subset(data,group=="blue"),aes(x=field.type,y=prop))+
  stat_boxplot(color="black")+
  geom_boxplot(outlier.shape=NA,fill="#A6A6A6",color="black")+
  geom_point(color="black",position="jitter")+
  theme_bw()+
  scale_y_continuous(breaks=c(0.00,0.1,0.2,0.3,0.4,0.5),limits=c(0,0.5))+
  theme(axis.title.x=element_text(margin = margin(t = 20, r = 0, b = 0, l = 0),size=20))+
  theme(axis.title.y= element_text(margin = margin(t = 0, r = 20, b = 0, l = 0),size=20))+
  theme(text=element_text(size=16,family="Calibri"),axis.title.x = element_blank(),axis.title.y=element_blank())+
  theme(plot.margin = margin(t=40,r=20,b=10,l=20))+
  ggtitle("Cuba Group")+
  theme(plot.title = element_text(size = 16,hjust=0.5,family = "Calibri Light",margin = margin(t=0,r=0,b=10,l=0)))+
  theme(panel.border = element_blank(), panel.grid.major = element_blank(),panel.grid.minor = element_blank(), axis.line = element_line(colour = "black"))+
  geom_line(data=annotation_df1,aes(x=field.type,y=y))+
  geom_segment(data=annotation_df2,aes(x="conditioned",xend="control",y=0.47,yend=0.47))+
  geom_line(data=annotation_df3,aes(x=field.type,y=y))+
   annotate("text",
           x = c(1.5),
           y = c(0.5),
           label = c("p = 0.049"),
           family = "", fontface = 3, size=4)
figure4


figure5<-ggplot(subset(data,group=="orange"),aes(x=field.type,y=prop))+
  stat_boxplot(color="black")+
  geom_boxplot(outlier.shape=NA,fill="#707070",color="black")+
  geom_point(color="black",position="jitter")+
  theme_bw()+
  scale_y_continuous(breaks=c(0.00,0.1,0.2,0.3,0.4,0.5),limits=c(0,0.5))+
  theme(axis.title.x=element_text(margin = margin(t = 20, r = 0, b = 0, l = 0),size=20))+
  theme(axis.title.y= element_text(margin = margin(t = 0, r = 20, b = 0, l = 0),size=20))+
  theme(text=element_text(size=16,family="Calibri"),axis.title.x = element_blank(),axis.title.y=element_blank())+
  theme(plot.margin = margin(t=40,r=20,b=10,l=20))+
  ggtitle("New England Group")+
  theme(plot.title = element_text(size = 16,hjust=0.5,family = "Calibri Light",margin = margin(t=0,r=0,b=10,l=0)))+
  theme(panel.border = element_blank(), panel.grid.major = element_blank(),panel.grid.minor = element_blank(), axis.line = element_line(colour = "black"))+
  geom_line(data=annotation_df1,aes(x=field.type,y=y))+
  geom_segment(data=annotation_df2,aes(x="conditioned",xend="control",y=0.47,yend=0.47))+
  geom_line(data=annotation_df3,aes(x=field.type,y=y))+
   annotate("text",
           x = c(1.5),
           y = c(0.5),
           label = c("p = 0.028"),
           family = "", fontface = 3, size=4)
figure5

figure6<-plot_grid(figure2,figure3,figure5,figure4,rel_widths = c(1,1),rel_heights = c(1,1))+
  draw_label("A",fontfamily = "Calibri Light", x = 0.01, y = 1, hjust = -0.5, vjust = 1.5)+
  draw_label("B",fontfamily = "Calibri Light",x=0.5,y=1,hjust=0.5,vjust=1.5)+
  draw_label("C",fontfamily = "Calibri Light",x=0.01,y=0.5,hjust=-0.5,vjust=1.5)+
  draw_label("D",fontfamily = "Calibri Light",x=0.5,y=0.5,hjust=0.5,vjust=1.5)
figure6
grid.arrange(arrangeGrob(figure6,
                         bottom = text_grob("Treatment", color = "black",
                                            hjust = 0.5, size = 18,family="Calibri Light"),
                         left = text_grob("Proportion of Time", color = "black",
                                          rot=90,size=18,family="Calibri Light"),padding=unit(1,"line")))


figure7<-ggplot(data,aes(x=field.type,y=prop))+
  stat_summary(fun.y="mean",geom="bar",fill="grey48")+
  stat_summary(fun.y=mean,fun.ymin = function(x) mean(x)-sd(x)/length(x),fun.ymax = function(x) mean(x) +
                 sd(x)/length(x),geom="errorbar",color="black")+
  theme_bw()+
  scale_y_continuous(name="Proportion of Time",breaks=c(0.00,0.05,0.1,0.15,0.2),expand = c(0,0))+
  scale_x_discrete(name="Treatment")+
  theme(plot.margin=margin(20,20,20,20))+
  theme(axis.title.y = element_text(margin = margin(t = 0, r = 20, b = 0, l = 0),size=20,family = "Calibri"),
        axis.title.x = element_text(margin = margin(t = 20, r = 0, b = 0, l = 0),size=20,family = "Calibri"))+
  theme(text=element_text(size=20,family="Calibri"))+
  coord_cartesian(ylim=c(0,0.15))+
  stat_compare_means(comparison=my_comparisons,label="p.signif",label.y = 0.14,method="wilcox.test")+
  theme(panel.border = element_blank(), axis.line = element_line(colour = "black"))
figure7


figure8<-ggplot(subset(data,group=="Red"),aes(x=field.type,y=prop))+
  stat_summary(fun.y="mean",geom="bar",color="black",fill="#DEDEDE")+
  stat_summary(fun.y=mean,fun.ymin = function(x) mean(x)-sd(x)/length(x),fun.ymax = function(x) mean(x) + sd(x)/length(x),geom="errorbar",color="black")+
  theme_bw()+
  scale_y_continuous(breaks=c(0,0.05,0.1,0.15,0.2),expand = c(0,0),"Proportion of Time")+
  coord_cartesian(ylim=c(0,0.2))+
  scale_x_discrete("Treatment")+
  ggtitle("Canada Group") +
  theme(text=element_text(size=18,family="calibri"))+
  theme(plot.title = element_text(margin = margin(t = 0, r = 0, b = 20, l = 0),hjust=0.5))+
  theme(plot.margin = unit(c(0.2,0.2,0.3,0.2),"cm"))+
  theme(axis.title.y = element_text(margin = margin(t = 0, r = 20, b = 0, l = 0),size=20,family = "Calibri"),
        axis.title.x = element_text(margin = margin(t = 20, r = 0, b = 0, l = 0),size=20,family = "Calibri"))+
  stat_compare_means(comparison=my_comparisons,label.y = 0.17,method="wilcox.test")+
  theme(panel.border = element_blank(), axis.line = element_line(colour = "black"))+
  theme(axis.title.x = element_blank(),axis.title.y=element_blank())
figure8

figure9<-ggplot(subset(data,group=="Purple"),aes(x=field.type,y=prop))+
  stat_summary(fun.y="mean",geom="bar",color="black",fill="#BABABA")+
  stat_summary(fun.y=mean,fun.ymin = function(x) mean(x)-sd(x)/length(x),fun.ymax = function(x) mean(x) + sd(x)/length(x),geom="errorbar",color="black")+
  theme_bw()+
  scale_y_continuous(breaks=c(0,0.05,0.1,0.15,0.2),expand = c(0,0),"Proportion of Time")+
  coord_cartesian(ylim=c(0,0.2))+
  scale_x_discrete("Treatment")+
  ggtitle("Bahamas Group") +
  theme(text=element_text(size=18,family="calibri"))+
  theme(plot.title = element_text(margin = margin(t = 0, r = 0, b = 20, l = 0),hjust=0.5))+
  theme(plot.margin = unit(c(0.2,0.2,0.3,0.2),"cm"))+
  theme(axis.title.y = element_text(margin = margin(t = 0, r = 20, b = 0, l = 0),size=20,family = "Calibri"),
        axis.title.x = element_text(margin = margin(t = 20, r = 0, b = 0, l = 0),size=20,family = "Calibri"))+
  stat_compare_means(comparison=my_comparisons,label.y = 0.17,method="wilcox.test")+
  theme(panel.border = element_blank(), axis.line = element_line(colour = "black"))+
  theme(axis.title.x = element_blank(),axis.title.y=element_blank())
figure9

figure10<-ggplot(subset(data,group=="blue"),aes(x=field.type,y=prop))+
  stat_summary(fun.y="mean",geom="bar",color="black",fill="#A6A6A6")+
  stat_summary(fun.y=mean,fun.ymin = function(x) mean(x)-sd(x)/length(x),fun.ymax = function(x) mean(x) + sd(x)/length(x),geom="errorbar",color="black")+
  theme_bw()+
  scale_y_continuous(breaks=c(0,0.05,0.1,0.15,0.2),expand=c(0,0),"Proportion of Time")+
  coord_cartesian(ylim=c(0,0.2))+
  scale_x_discrete("Treatment")+
  ggtitle("Cuba Group") +
  theme(text=element_text(size=18,family="calibri"))+
  theme(plot.title = element_text(margin = margin(t = 0, r = 0, b = 20, l = 0),hjust=0.5))+
  theme(plot.margin = unit(c(0.2,0.2,0.3,0.2),"cm"))+
  theme(axis.title.y = element_text(margin = margin(t = 0, r = 20, b = 0, l = 0),size=20,family = "Calibri"),
        axis.title.x = element_text(margin = margin(t = 20, r = 0, b = 0, l = 0),size=20,family = "Calibri"))+
  stat_compare_means(comparison=my_comparisons,label.y = 0.17,method="wilcox.test")+
  theme(panel.border = element_blank(), axis.line = element_line(colour = "black"))+
  theme(axis.title.x = element_blank(),axis.title.y=element_blank())
figure10

figure11<-ggplot(subset(data,group=="orange"),aes(x=field.type,y=prop))+
  stat_summary(fun.y="mean",geom="bar",color="black",fill="#707070")+
  stat_summary(fun.y=mean,fun.ymin = function(x) mean(x)-sd(x)/length(x),fun.ymax = function(x) mean(x) + sd(x)/length(x),geom="errorbar",color="black")+
  theme_bw()+
  scale_y_continuous(breaks=c(0,0.05,0.1,0.15,0.2),expand = c(0,0),"Proportion of Time")+
  coord_cartesian(ylim=c(0,0.2))+
  scale_x_discrete("Treatment")+
  ggtitle("New England Group") +
  theme(text=element_text(size=18,family="calibri"))+
  theme(plot.title = element_text(margin = margin(t = 0, r = 0, b = 20, l = 0),hjust=0.5))+
  theme(plot.margin = unit(c(0.2,0.2,0.3,0.2),"cm"))+
  theme(axis.title.y = element_text(margin = margin(t = 0, r = 20, b = 0, l = 0),size=20,family = "Calibri"),
        axis.title.x = element_text(margin = margin(t = 20, r = 0, b = 0, l = 0),size=20,family = "Calibri"))+
  stat_compare_means(comparison=my_comparisons,label.y = 0.17,method="wilcox.test")+
  theme(panel.border = element_blank(), axis.line = element_line(colour = "black"))+
  theme(axis.title.x = element_blank(),axis.title.y=element_blank())
figure11

figure12<-plot_grid(figure8,figure9,figure10,figure11,rel_widths = c(1,1))+
  draw_label("A",fontfamily = "Calibri", x = 0, y = 1, hjust = -0.5, vjust = 1.5)+
  draw_label("B",fontfamily = "Calibri",x=0.5,y=1,hjust=0.5,vjust=1.5)+
  draw_label("C",fontfamily = "Calibri",x=0.01,y=0.5,hjust=0.5,vjust=1.5)+
  draw_label("D",fontfamily = "Calibri",x=0.5,y=0.5,hjust=0.5,vjust=1.5)
figure12
grid.arrange(arrangeGrob(figure12,top=text_grob(""),
                         bottom = text_grob("Treatment", color = "black",
                                            hjust = 0.5, size = 20,family="Calibri"),
                         left = text_grob("Proportion of Time", color = "black",
                                          rot=90,size=20,family="Calibri"),padding=unit(2,"line")))


```


